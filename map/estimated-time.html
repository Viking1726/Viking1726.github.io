<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>预估车辆到达时间 |  </title>
    <meta name="description" content=" ">
    <link rel="shortcut icon" href="/WechatIMG1.png">
    
    <link rel="preload" href="/assets/css/styles.88dd2b02.css" as="style"><link rel="preload" href="/assets/js/app.88dd2b02.js" as="script"><link rel="preload" href="/assets/css/4.styles.7697dc17.css" as="style"><link rel="preload" href="/assets/js/4.7697dc17.js" as="script"><link rel="preload" href="/assets/css/0.styles.40367dbe.css" as="style"><link rel="preload" href="/assets/js/0.40367dbe.js" as="script"><link rel="preload" href="/assets/js/34.568c332d.js" as="script"><link rel="prefetch" href="/assets/css/10.styles.c309a477.css"><link rel="prefetch" href="/assets/css/12.styles.ec2f7c4c.css"><link rel="prefetch" href="/assets/css/13.styles.acd233ff.css"><link rel="prefetch" href="/assets/css/15.styles.068973d9.css"><link rel="prefetch" href="/assets/css/16.styles.75a9d63b.css"><link rel="prefetch" href="/assets/css/17.styles.997e85b7.css"><link rel="prefetch" href="/assets/css/18.styles.616954d3.css"><link rel="prefetch" href="/assets/css/19.styles.2a2c898e.css"><link rel="prefetch" href="/assets/css/2.styles.4691f751.css"><link rel="prefetch" href="/assets/css/20.styles.cb7bd78f.css"><link rel="prefetch" href="/assets/css/21.styles.11b38159.css"><link rel="prefetch" href="/assets/css/22.styles.60ad72ea.css"><link rel="prefetch" href="/assets/css/23.styles.9c6e3f19.css"><link rel="prefetch" href="/assets/css/24.styles.ba0b5736.css"><link rel="prefetch" href="/assets/css/5.styles.baeb1f92.css"><link rel="prefetch" href="/assets/css/6.styles.d7c06eed.css"><link rel="prefetch" href="/assets/css/7.styles.811821f7.css"><link rel="prefetch" href="/assets/css/8.styles.be6e98bf.css"><link rel="prefetch" href="/assets/css/9.styles.f5015641.css"><link rel="prefetch" href="/assets/js/10.c309a477.js"><link rel="prefetch" href="/assets/js/11.81a80c43.js"><link rel="prefetch" href="/assets/js/12.ec2f7c4c.js"><link rel="prefetch" href="/assets/js/13.acd233ff.js"><link rel="prefetch" href="/assets/js/14.77f430c4.js"><link rel="prefetch" href="/assets/js/15.068973d9.js"><link rel="prefetch" href="/assets/js/16.75a9d63b.js"><link rel="prefetch" href="/assets/js/17.997e85b7.js"><link rel="prefetch" href="/assets/js/18.616954d3.js"><link rel="prefetch" href="/assets/js/19.2a2c898e.js"><link rel="prefetch" href="/assets/js/20.cb7bd78f.js"><link rel="prefetch" href="/assets/js/21.11b38159.js"><link rel="prefetch" href="/assets/js/22.60ad72ea.js"><link rel="prefetch" href="/assets/js/23.9c6e3f19.js"><link rel="prefetch" href="/assets/js/24.ba0b5736.js"><link rel="prefetch" href="/assets/js/25.cce36918.js"><link rel="prefetch" href="/assets/js/26.eeb9c06b.js"><link rel="prefetch" href="/assets/js/27.0d3f9f17.js"><link rel="prefetch" href="/assets/js/28.e539e587.js"><link rel="prefetch" href="/assets/js/29.349d807c.js"><link rel="prefetch" href="/assets/js/30.1eb1ce5a.js"><link rel="prefetch" href="/assets/js/31.d3bd4f53.js"><link rel="prefetch" href="/assets/js/32.bc243508.js"><link rel="prefetch" href="/assets/js/33.48833d17.js"><link rel="prefetch" href="/assets/js/35.f1b3746d.js"><link rel="prefetch" href="/assets/js/36.07dcef59.js"><link rel="prefetch" href="/assets/js/37.6c98d18b.js"><link rel="prefetch" href="/assets/js/38.1395deb9.js"><link rel="prefetch" href="/assets/js/39.3a3fd6cd.js"><link rel="prefetch" href="/assets/js/40.1c0e6b1f.js"><link rel="prefetch" href="/assets/js/5.baeb1f92.js"><link rel="prefetch" href="/assets/js/6.d7c06eed.js"><link rel="prefetch" href="/assets/js/7.811821f7.js"><link rel="prefetch" href="/assets/js/8.be6e98bf.js"><link rel="prefetch" href="/assets/js/9.f5015641.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.4691f751.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.45d55d38.js">
    <link rel="stylesheet" href="/assets/css/0.styles.40367dbe.css"><link rel="stylesheet" href="/assets/css/10.styles.c309a477.css"><link rel="stylesheet" href="/assets/css/12.styles.ec2f7c4c.css"><link rel="stylesheet" href="/assets/css/13.styles.acd233ff.css"><link rel="stylesheet" href="/assets/css/15.styles.068973d9.css"><link rel="stylesheet" href="/assets/css/16.styles.75a9d63b.css"><link rel="stylesheet" href="/assets/css/17.styles.997e85b7.css"><link rel="stylesheet" href="/assets/css/18.styles.616954d3.css"><link rel="stylesheet" href="/assets/css/19.styles.2a2c898e.css"><link rel="stylesheet" href="/assets/css/2.styles.4691f751.css"><link rel="stylesheet" href="/assets/css/20.styles.cb7bd78f.css"><link rel="stylesheet" href="/assets/css/21.styles.11b38159.css"><link rel="stylesheet" href="/assets/css/22.styles.60ad72ea.css"><link rel="stylesheet" href="/assets/css/23.styles.9c6e3f19.css"><link rel="stylesheet" href="/assets/css/24.styles.ba0b5736.css"><link rel="stylesheet" href="/assets/css/4.styles.7697dc17.css"><link rel="stylesheet" href="/assets/css/5.styles.baeb1f92.css"><link rel="stylesheet" href="/assets/css/6.styles.d7c06eed.css"><link rel="stylesheet" href="/assets/css/7.styles.811821f7.css"><link rel="stylesheet" href="/assets/css/8.styles.be6e98bf.css"><link rel="stylesheet" href="/assets/css/9.styles.f5015641.css"><link rel="stylesheet" href="/assets/css/styles.88dd2b02.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name"> </span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="https://github.com/Viking1726" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="https://github.com/Viking1726" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/home/home.html" class="sidebar-link">home page</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JAVA 片段</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>HTML 片段</span> <span class="arrow right"></span></p> <!----></div></li><li><a href="/mysql/mysql.html" class="sidebar-link">MYSQL 片段</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>流媒体</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>地图</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/map/map-bubble.html" class="sidebar-link">地图气泡</a></li><li><a href="/map/estimated-time.html" class="active sidebar-link">预估车辆到达时间</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/map/estimated-time.html#流程1" class="sidebar-link">流程1</a></li><li class="sidebar-sub-header"><a href="/map/estimated-time.html#流程2" class="sidebar-link">流程2</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content default"><h1 id="估车辆到站时间"><a href="#估车辆到站时间" aria-hidden="true" class="header-anchor">#</a> 估车辆到站时间</h1> <h2 id="流程1"><a href="#流程1" aria-hidden="true" class="header-anchor">#</a> 流程1</h2> <div class="vuepress-flowchart loading"><svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 30 30" class="vuepress-flowchart-loading-icon" style="enable-background:new 0 0 50 50;"><rect x="0" y="13" width="4" height="5"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0s" dur="0.6s" repeatCount="indefinite"></animate> <animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0s" dur="0.6s" repeatCount="indefinite"></animate></rect> <rect x="10" y="13" width="4" height="5"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0.15s" dur="0.6s" repeatCount="indefinite"></animate> <animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0.15s" dur="0.6s" repeatCount="indefinite"></animate></rect> <rect x="20" y="13" width="4" height="5"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0.3s" dur="0.6s" repeatCount="indefinite"></animate> <animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0.3s" dur="0.6s" repeatCount="indefinite"></animate></rect></svg></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>司机扫码：更新车辆当前状态 线路信息 上下行</p></div> <div class="language-java extra-class"><pre class="language-java"><code>String deviceId <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;deviceId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String lineId <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;lineId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String scanTime <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;scanTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SimpleDateFormat simpleDateFormat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>deviceId <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> lineId <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> scanTime <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// supplier 设备车辆关系实体类</span>
    Supplier supplier <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">selectSupplierByCode</span><span class="token punctuation">(</span>deviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 取出车牌号</span>
    String numberPlate <span class="token operator">=</span> supplier<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 根据车牌号取出当前的车辆状态记录表</span>
    BPalmarTraffic bPalmarTraffic <span class="token operator">=</span> bPalmarTrafficService<span class="token punctuation">.</span><span class="token function">selectByNumberPlate</span><span class="token punctuation">(</span>numberPlate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 取出线路</span>
    Line line <span class="token operator">=</span> lineService<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>lineId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bPalmarTraffic <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> line <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> numberPlate <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bPalmarTraffic<span class="token punctuation">.</span><span class="token function">setLineId</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">getLineId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bPalmarTraffic<span class="token punctuation">.</span><span class="token function">setUpdown</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">getUpdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 取出当前线路所有站点</span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>LineStation<span class="token punctuation">&gt;</span></span> lineStations <span class="token operator">=</span> lineStationService<span class="token punctuation">.</span><span class="token function">selectByLine</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">getLineId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> line<span class="token punctuation">.</span><span class="token function">getUpdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 记录当前线路的站点</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;lineStations&quot;</span><span class="token punctuation">,</span> lineStations<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">// 记录当亲的线路</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;lineId&quot;</span><span class="token punctuation">,</span> lineId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据车牌号尝试从redis中取出 基本信息</span>
        String redisJsonStr <span class="token operator">=</span> redisService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>numberPlate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>redisJsonStr <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 若当前线路和redis已存线路不同则更新扫码时间(避免重复扫码)</span>
            JSONObject jsonObject <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>redisJsonStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            String redisLineId <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;lineId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>redisLineId <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>lineId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisLineId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;scanTime&quot;</span><span class="token punctuation">,</span> simpleDateFormat<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>scanTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           	<span class="token comment">// 若redis无数据也更扫码时间</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;scanTime&quot;</span><span class="token punctuation">,</span> simpleDateFormat<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>scanTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        redisService<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>numberPlate<span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bPalmarTrafficService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>bPalmarTraffic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre></div><h2 id="流程2"><a href="#流程2" aria-hidden="true" class="header-anchor">#</a> 流程2</h2> <div class="vuepress-flowchart loading"><svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 30 30" class="vuepress-flowchart-loading-icon" style="enable-background:new 0 0 50 50;"><rect x="0" y="13" width="4" height="5"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0s" dur="0.6s" repeatCount="indefinite"></animate> <animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0s" dur="0.6s" repeatCount="indefinite"></animate></rect> <rect x="10" y="13" width="4" height="5"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0.15s" dur="0.6s" repeatCount="indefinite"></animate> <animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0.15s" dur="0.6s" repeatCount="indefinite"></animate></rect> <rect x="20" y="13" width="4" height="5"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0.3s" dur="0.6s" repeatCount="indefinite"></animate> <animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0.3s" dur="0.6s" repeatCount="indefinite"></animate></rect></svg></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>车辆行驶：10s一次心跳 上传经纬度信息
根据已有的站点信息 计算车辆到剩余站所需时间</p></div> <div class="language-java extra-class"><pre class="language-java"><code>String deviceId <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;deviceId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String longitude <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;longitude&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String latitude <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;latitude&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>deviceId <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> longitude <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> latitude <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 根据deviceId获取车牌号</span>
Supplier supplier <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">selectSupplierByCode</span><span class="token punctuation">(</span>deviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
String numberPlate <span class="token operator">=</span> supplier<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// redis中获取 所需基本信息</span>
List<span class="token generics function"><span class="token punctuation">&lt;</span>LineStation<span class="token punctuation">&gt;</span></span> lineStations <span class="token operator">=</span> null<span class="token punctuation">;</span>
Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> redisMap <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>numberPlate <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    String jsonMap <span class="token operator">=</span> redisService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>numberPlate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>jsonMap <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redisMap <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>jsonMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lineStations <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>redisMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;lineStations&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> LineStation<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 处理心跳经纬度</span>
<span class="token keyword">double</span> plng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>longitude<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> BigDecimal<span class="token punctuation">.</span>ROUND_HALF_UP<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> plat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>latitude<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> BigDecimal<span class="token punctuation">.</span>ROUND_HALF_UP<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postPoi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>plng<span class="token punctuation">,</span> plat<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 根据车牌号获取当前车辆状态</span>
BPalmarTraffic bPalmarTraffic <span class="token operator">=</span> bPalmarTrafficService<span class="token punctuation">.</span><span class="token function">selectByNumberPlate</span><span class="token punctuation">(</span>numberPlate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token comment">// 更新车辆状态经纬度    </span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>bPalmarTraffic <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bPalmarTraffic<span class="token punctuation">.</span><span class="token function">setLatitude</span><span class="token punctuation">(</span>latitude<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bPalmarTraffic<span class="token punctuation">.</span><span class="token function">setLongitude</span><span class="token punctuation">(</span>longitude<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bPalmarTraffic<span class="token punctuation">.</span><span class="token function">setInstation</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 取出并更新redis中车辆经纬度</span>
JSONArray redisPoi <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redisMap <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    redisPoi <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>JSONObject<span class="token punctuation">)</span> redisMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getJSONArray</span><span class="token punctuation">(</span><span class="token string">&quot;location&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;location&quot;</span><span class="token punctuation">,</span> postPoi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisService<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>numberPlate<span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>redisMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

 <span class="token comment">// 计算10s的速度(理论十秒的心跳)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redisPoi <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">double</span> distance <span class="token operator">=</span> BmapApi<span class="token punctuation">.</span><span class="token function">GetDistance</span><span class="token punctuation">(</span>redisPoi<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> redisPoi<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> postPoi<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> postPoi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> speed <span class="token operator">=</span> distance <span class="token operator">/</span> <span class="token number">36</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bPalmarTraffic <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bPalmarTraffic<span class="token punctuation">.</span><span class="token function">setSpeed</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

 <span class="token comment">// 计算是否到达站点   </span>
String currentOrderNum <span class="token operator">=</span> null<span class="token punctuation">;</span>
List<span class="token operator">&lt;</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span> dbPoi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>lineStations <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lineStations<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        Station station <span class="token operator">=</span> stationService<span class="token punctuation">.</span><span class="token function">selectByStation</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getStationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> blng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>station<span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> BigDecimal<span class="token punctuation">.</span>ROUND_HALF_UP<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> blat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>station<span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> BigDecimal<span class="token punctuation">.</span>ROUND_HALF_UP<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> poi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>blng<span class="token punctuation">,</span> blat<span class="token punctuation">}</span><span class="token punctuation">;</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getOrderNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> poi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dbPoi<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentOrderNum <span class="token operator">=</span> BmapApi<span class="token punctuation">.</span><span class="token function">checkPoi</span><span class="token punctuation">(</span>postPoi<span class="token punctuation">,</span> dbPoi<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 若到站 剔除站点</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>currentOrderNum <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lineStations <span class="token operator">=</span> lineStations<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>currentOrderNum<span class="token punctuation">)</span><span class="token punctuation">,</span> lineStations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bPalmarTraffic <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bPalmarTraffic<span class="token punctuation">.</span><span class="token function">setInstation</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>redisMap <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redisMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;lineStations&quot;</span><span class="token punctuation">,</span> lineStations<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

    
 <span class="token comment">// 更新redis 基本信息的站点</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redisMap <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    redisService<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>numberPlate<span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>redisMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 计算剩余站点 所需到达时间</span>
LineStation nextLineStation <span class="token operator">=</span> null<span class="token punctuation">;</span>
List<span class="token operator">&lt;</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> estimatedTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>lineStations <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> lineStations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nextLineStation <span class="token operator">=</span> lineStations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bPalmarTraffic <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bPalmarTraffic<span class="token punctuation">.</span><span class="token function">setNextStationId</span><span class="token punctuation">(</span>nextLineStation<span class="token punctuation">.</span><span class="token function">getStationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bPalmarTraffic<span class="token punctuation">.</span><span class="token function">setNextStationName</span><span class="token punctuation">(</span>nextLineStation<span class="token punctuation">.</span><span class="token function">getStationName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bPalmarTraffic<span class="token punctuation">.</span><span class="token function">setNextStationNum</span><span class="token punctuation">(</span>nextLineStation<span class="token punctuation">.</span><span class="token function">getOrderNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>LineStation item <span class="token operator">:</span> lineStations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;coord_type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;wgs84&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;origin&quot;</span><span class="token punctuation">,</span> postPoi<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> postPoi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Station station <span class="token operator">=</span> stationService<span class="token punctuation">.</span><span class="token function">selectByStation</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getStationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> lng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>station<span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> BigDecimal<span class="token punctuation">.</span>ROUND_HALF_UP<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> lat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>station<span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> BigDecimal<span class="token punctuation">.</span>ROUND_HALF_UP<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;destination&quot;</span><span class="token punctuation">,</span> lat <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> lng<span class="token punctuation">)</span><span class="token punctuation">;</span>
        JSONObject result <span class="token operator">=</span> BmapApi<span class="token punctuation">.</span><span class="token function">driving</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            params<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;stationNum&quot;</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getOrderNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;duration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            estimatedTime<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lineStations<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> bPalmarTraffic <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                bPalmarTraffic<span class="token punctuation">.</span><span class="token function">setNextStationDistance</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;distance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 从redis 司机扫码时间 获取后续乘客扫码数量</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redisMap <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    String time <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>JSONObject<span class="token punctuation">)</span> redisMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;scanTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SimpleDateFormat simpleDateFormat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Date date <span class="token operator">=</span> simpleDateFormat<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>ScanRecords<span class="token punctuation">&gt;</span></span> personScanRecords <span class="token operator">=</span> scanRecordsService<span class="token punctuation">.</span><span class="token function">selectPersonScanRecords</span><span class="token punctuation">(</span>deviceId<span class="token punctuation">,</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bPalmarTraffic <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            bPalmarTraffic<span class="token punctuation">.</span><span class="token function">setPassengers</span><span class="token punctuation">(</span>personScanRecords<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

 <span class="token comment">// 更新车辆状态信息</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>bPalmarTraffic <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bPalmarTraffic<span class="token punctuation">.</span><span class="token function">setEstimatedTime</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>estimatedTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bPalmarTraffic<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bPalmarTrafficService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>bPalmarTraffic<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>百度地图web服务api   <a href="http://lbsyun.baidu.com/index.php?title=webapi/direction-api-v2" target="_blank" rel="noopener noreferrer">驾车路线规划<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>http请求自己封装或百度</p></div> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BmapApi</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> String DRIVING <span class="token operator">=</span> <span class="token string">&quot;http://api.map.baidu.com/direction/v2/driving&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">double</span> EARTH_RADIUS <span class="token operator">=</span> <span class="token number">6378.137</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">rad</span><span class="token punctuation">(</span><span class="token keyword">double</span> d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> d <span class="token operator">*</span> Math<span class="token punctuation">.</span>PI <span class="token operator">/</span> <span class="token number">180.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取两点之间的距离</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">GetDistance</span><span class="token punctuation">(</span><span class="token keyword">double</span> lat1<span class="token punctuation">,</span> <span class="token keyword">double</span> lng1<span class="token punctuation">,</span> <span class="token keyword">double</span> lat2<span class="token punctuation">,</span> <span class="token keyword">double</span> lng2<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">double</span> radLat1 <span class="token operator">=</span> <span class="token function">rad</span><span class="token punctuation">(</span>lat1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> radLat2 <span class="token operator">=</span> <span class="token function">rad</span><span class="token punctuation">(</span>lat2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> a <span class="token operator">=</span> radLat1 <span class="token operator">-</span> radLat2<span class="token punctuation">;</span>
        <span class="token keyword">double</span> b <span class="token operator">=</span> <span class="token function">rad</span><span class="token punctuation">(</span>lng1<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">rad</span><span class="token punctuation">(</span>lng2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> s <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">asin</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>a<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>radLat1<span class="token punctuation">)</span><span class="token operator">*</span>Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>radLat2<span class="token punctuation">)</span><span class="token operator">*</span>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>b<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        s <span class="token operator">=</span> s <span class="token operator">*</span> EARTH_RADIUS<span class="token punctuation">;</span>
        s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>s <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10000</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 检测坐标点是否在某个点的一点范围内</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">checkPoi</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postPoi<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span> dbPoi<span class="token punctuation">,</span> <span class="token keyword">int</span> scope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> inStation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dbPoi<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            item<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>_item <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> poi <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>_item<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">double</span> lngDistance <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>poi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> postPoi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">double</span> latDistance <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>poi<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> postPoi<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">double</span> targetScope <span class="token operator">=</span> scope <span class="token operator">*</span> <span class="token number">0.00001</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>latDistance <span class="token operator">&lt;</span> targetScope <span class="token operator">&amp;&amp;</span> lngDistance <span class="token operator">&lt;</span> targetScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    inStation<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>_item<span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>_item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inStation<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>inStation<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


	<span class="token comment">// 请求并解析返回的json</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> JSONObject <span class="token function">driving</span><span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;ak&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;***************************&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        String result <span class="token operator">=</span> HttpRequestUtil<span class="token punctuation">.</span><span class="token function">sendGet</span><span class="token punctuation">(</span>DRIVING<span class="token punctuation">,</span> BmapApi<span class="token punctuation">.</span><span class="token function">changeParam</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            JSONObject jsonAll <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>jsonAll <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>jsonAll<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                JSONObject jsonResult <span class="token operator">=</span> jsonAll<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">&quot;result&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>jsonResult <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    JSONArray jsonRoutes <span class="token operator">=</span> jsonResult<span class="token punctuation">.</span><span class="token function">getJSONArray</span><span class="token punctuation">(</span><span class="token string">&quot;routes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> jsonRoutes<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 参数组装</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">changeParam</span><span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> paramStr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        params<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            paramStr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> item<span class="token punctuation">;</span>
            paramStr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token string">&quot;=&quot;</span><span class="token punctuation">;</span>
            paramStr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            paramStr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String s <span class="token operator">=</span> paramStr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间: </span> <span class="time">9/15/2019, 11:38:31 AM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/map/map-bubble.html" class="prev">
        地图气泡
      </a></span> <!----></p></div>  <div id="gitalk-container" class="content default"></div></div> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/4.7697dc17.js" defer></script><script src="/assets/js/0.40367dbe.js" defer></script><script src="/assets/js/34.568c332d.js" defer></script><script src="/assets/js/app.88dd2b02.js" defer></script>
  </body>
</html>
